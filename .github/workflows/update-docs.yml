name: ğŸ“š Auto-Update Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'supabase/migrations/**'
      - '__tests__/**'
      - 'package.json'
  pull_request:
    branches: [ main ]
  schedule:
    # ExÃ©cution quotidienne Ã  6h UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Permet l'exÃ©cution manuelle

jobs:
  update-documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¥ Install dependencies
      run: npm ci

    - name: ğŸ” Run documentation updater
      run: node scripts/update-documentation.js

    - name: ğŸ“Š Generate project metrics
      run: |
        echo "## ğŸ“ˆ MÃ©triques du Projet" > metrics.md
        echo "GÃ©nÃ©rÃ© le: $(date)" >> metrics.md
        echo "" >> metrics.md
        echo "### Statistiques du Code" >> metrics.md
        echo "- Fichiers TypeScript/JavaScript: $(find src -name '*.ts' -o -name '*.tsx' -o -name '*.js' -o -name '*.jsx' | wc -l)" >> metrics.md
        echo "- Composants React: $(find src -name '*.tsx' | grep -v test | wc -l)" >> metrics.md
        echo "- Pages: $(find src/pages -name '*.tsx' | wc -l)" >> metrics.md
        echo "- Services: $(find src/services -name '*.ts' | wc -l)" >> metrics.md
        echo "- Hooks: $(find src/hooks -name '*.ts' -o -name '*.tsx' | wc -l)" >> metrics.md
        echo "- Tests: $(find . -name '*.test.*' -o -name '*.spec.*' | wc -l)" >> metrics.md
        echo "- Migrations Supabase: $(find supabase/migrations -name '*.sql' | wc -l)" >> metrics.md
        echo "" >> metrics.md
        echo "### Taille du Projet" >> metrics.md
        echo "- Lignes de code (src/): $(find src -name '*.ts' -o -name '*.tsx' | xargs wc -l | tail -1 | awk '{print $1}')" >> metrics.md
        echo "- Taille totale: $(du -sh . | cut -f1)" >> metrics.md

    - name: ğŸ§ª Run tests to validate documentation
      run: |
        # VÃ©rifier que les tests passent aprÃ¨s mise Ã  jour
        npm test -- --run --reporter=verbose || echo "âš ï¸ Tests en Ã©chec - documentation mise Ã  jour quand mÃªme"

    - name: ğŸ“ Check for changes
      id: changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ Changements dÃ©tectÃ©s dans la documentation"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "âœ… Aucun changement nÃ©cessaire"
        fi

    - name: ğŸ’¾ Commit and push changes
      if: steps.changes.outputs.changes == 'true'
      run: |
        git add README.md project-status.json docs/auto-update-report.json metrics.md
        git commit -m "ğŸ“š Auto-update documentation
        
        - Synchronisation avec l'Ã©tat rÃ©el du code
        - Mise Ã  jour des pourcentages d'avancement
        - GÃ©nÃ©ration des mÃ©triques projet
        - Rapport automatique: $(date)"
        git push

    - name: ğŸ“‹ Create summary
      run: |
        echo "## ğŸ“š RÃ©sumÃ© de la Mise Ã  Jour Documentation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Actions EffectuÃ©es" >> $GITHUB_STEP_SUMMARY
        echo "- Analyse automatique du code source" >> $GITHUB_STEP_SUMMARY
        echo "- Mise Ã  jour de README.md" >> $GITHUB_STEP_SUMMARY
        echo "- Mise Ã  jour de project-status.json" >> $GITHUB_STEP_SUMMARY
        echo "- GÃ©nÃ©ration des mÃ©triques projet" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š MÃ©triques Actuelles" >> $GITHUB_STEP_SUMMARY
        cat metrics.md >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [[ -f docs/auto-update-report.json ]]; then
          echo "### ğŸ“‹ Rapport DÃ©taillÃ©" >> $GITHUB_STEP_SUMMARY
          echo "Voir: \`docs/auto-update-report.json\`" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ”” Notify on significant changes
      if: steps.changes.outputs.changes == 'true'
      run: |
        echo "ğŸ‰ Documentation mise Ã  jour automatiquement!"
        echo "Les changements ont Ã©tÃ© committÃ©s et poussÃ©s vers la branche."
